<!-- templates/prediction.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prediction â€” AI Stock Predictor</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <style>
    :root{
      --bg:#0f1724; --card:#0f1724; --muted:#94a3b8; --accent:#00e6ff; --good:#00ff9d; --bad:#ff4d7c;
      --panel:#111827; --card-border:#2a2a4a; --mono: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#080813 0%, #0f1724 100%);font-family:var(--mono);color:#fff}
    .container{max-width:1100px;margin:28px auto;padding:22px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    header h1{font-size:20px;color:var(--accent);margin:0}
    .card{background:var(--panel);border:1px solid var(--card-border);border-radius:12px;padding:18px;margin-bottom:16px;box-shadow:0 6px 22px rgba(0,0,0,.4)}
    .grid{display:flex;gap:16px;flex-wrap:wrap}
    .col{flex:1;min-width:240px}
    label{display:block;color:var(--muted);font-size:13px;margin-bottom:8px}
    input[type=text]{width:100%;padding:12px;border-radius:10px;border:1px solid #263044;background:#0b1220;color:#fff;font-size:15px}
    button.primary{background:linear-gradient(90deg,var(--accent),#00ff9d);border:none;color:#072025;padding:12px 16px;border-radius:10px;font-weight:700;cursor:pointer}
    .result-row{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .stat{flex:1;min-width:150px;padding:12px;border-radius:8px;background:#0b1220;border:1px solid #222;color:#fff}
    pre{white-space:pre-wrap;background:#07101a;padding:12px;border-radius:8px;border:1px solid #18262f;color:#e6f7ff}
    .small{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ðŸ”® AI Multi-Target Stock Prediction</h1>
      <div class="small">Prediction engine â€” Flask API (models persisted)</div>
    </header>

    <div class="card">
      <div class="grid">
        <div class="col">
          <label for="ticker">Stock Ticker</label>
          <input id="ticker" type="text" placeholder="e.g., AAPL, SPY, TSLA" value="SPY"/>
        </div>
        <div class="col" style="flex:0 0 220px;display:flex;align-items:end;justify-content:flex-end">
          <button id="predictBtn" class="primary">ðŸš€ Predict</button>
        </div>
      </div>

      <div id="status" class="small" style="margin-top:12px;color:var(--muted)">Enter a ticker and click Predict. Models are saved on first train and reused later.</div>
    </div>

    <div id="output" class="card" style="display:none"></div>
  </div>

  <script>
    const btn = document.getElementById('predictBtn');
    const tickerInput = document.getElementById('ticker');
    const output = document.getElementById('output');
    const status = document.getElementById('status');

    function formatCurrency(n){
      try{ return '$' + Number(n).toFixed(2); } catch(e){ return String(n); }
    }

    function renderResult(obj){
      output.style.display = 'block';
      output.innerHTML = '';

      // Top summary
      const h = document.createElement('div');
      h.innerHTML = `
        <h2 style="margin:0 0 8px 0;color:var(--accent)">Prediction â€” ${obj.symbol}</h2>
        <div class="small">Prediction date: ${obj.prediction_date} â€¢ Market: ${obj.market_status}</div>
        <div class="result-row" style="margin-top:12px">
          <div class="stat">
            <div class="small">Current Price</div>
            <div style="font-size:22px;font-weight:700">${formatCurrency(obj.current_price)}</div>
            <div class="small">Last trading day: ${obj.last_trading_day}</div>
          </div>
          <div class="stat">
            <div class="small">Predicted Close</div>
            <div style="font-size:22px;font-weight:700">${formatCurrency(obj.predicted_prices.close)}</div>
            <div style="font-weight:700;color:${obj.change_percent>=0? 'var(--good)':'var(--bad)'}">${obj.change_percent>=0? 'â–²':'â–¼'} ${obj.change_percent}%</div>
          </div>
          <div class="stat">
            <div class="small">Risk Level</div>
            <div style="font-size:18px;font-weight:700">${obj.risk_level}</div>
            <div class="small">Crisis Prob: ${ (obj.crisis_probability*100).toFixed(1) }%</div>
          </div>
        </div>
        <div style="margin-top:12px">
          <strong>Recommendation:</strong> ${obj.recommendation}
        </div>
      `;
      output.appendChild(h);

      // detailed predictions
      const details = document.createElement('div');
      details.style.marginTop = '16px';
      details.innerHTML = `
        <h3 style="color:var(--accent);margin:0 0 10px 0">Multi-target Predictions</h3>
        <div class="result-row">
          <div class="stat"><div class="small">Open</div><div style="font-weight:700">${formatCurrency(obj.predicted_prices.open)}</div></div>
          <div class="stat"><div class="small">High</div><div style="font-weight:700">${formatCurrency(obj.predicted_prices.high)}</div></div>
          <div class="stat"><div class="small">Low</div><div style="font-weight:700">${formatCurrency(obj.predicted_prices.low)}</div></div>
          <div class="stat"><div class="small">Close</div><div style="font-weight:700">${formatCurrency(obj.predicted_prices.close)}</div></div>
        </div>
      `;
      output.appendChild(details);

      // scenarios
      const scen = document.createElement('div');
      scen.style.marginTop = '16px';
      scen.innerHTML = `<h3 style="color:var(--accent);margin:0 0 10px 0">Market Scenarios</h3>`;
      const sbox = document.createElement('div'); sbox.className = 'result-row';
      ['base','bullish','bearish','sideways'].forEach(key => {
        const sc = obj.scenarios && obj.scenarios[key] ? obj.scenarios[key] : null;
        const card = document.createElement('div'); card.className='stat';
        card.innerHTML = `<div style="font-weight:700">${key.toUpperCase()}</div>
                          <div class="small">Prob: ${sc? sc.probability : 'N/A'}%</div>
                          <div style="margin-top:8px">${sc? sc.description : 'N/A'}</div>
                          <div style="margin-top:8px" class="small">Change: ${sc? (sc.price_change||0).toFixed(2) + '%' : 'N/A'}</div>`;
        sbox.appendChild(card);
      });
      scen.appendChild(sbox);
      output.appendChild(scen);

      // risk alerts
      const alerts = document.createElement('div'); alerts.style.marginTop='16px';
      alerts.innerHTML = `<h3 style="color:var(--accent);margin:0 0 10px 0">Risk Alerts</h3>`;
      if(obj.risk_alerts && obj.risk_alerts.length>0){
        obj.risk_alerts.forEach(a => {
          const el = document.createElement('div'); el.className='stat';
          el.style.marginBottom='8px';
          el.innerHTML = `<div style="font-weight:700">${a.level} â€” ${a.type}</div><div class="small">${a.message}</div><div class="small">Action: ${a.action}</div>`;
          alerts.appendChild(el);
        });
      } else {
        const el = document.createElement('div'); el.className='stat'; el.innerHTML = `<div class="small">No critical risk alerts detected</div>`; alerts.appendChild(el);
      }
      output.appendChild(alerts);

      // model health + raw JSON toggle
      const raw = document.createElement('div'); raw.style.marginTop='16px';
      raw.innerHTML = `<h3 style="color:var(--accent);margin:0 0 10px 0">Model Health</h3>
                       <div class="small">Trained: ${obj.model_health.training_date || 'N/A'} â€¢ Data points: ${obj.data_analysis.total_data_points || 'N/A'}</div>
                       <details style="margin-top:10px">
                         <summary style="cursor:pointer;color:var(--muted)">Show raw response JSON</summary>
                         <pre>${JSON.stringify(obj, null, 2)}</pre>
                       </details>`;
      output.appendChild(raw);
    }

    async function runPrediction(){
      const ticker = tickerInput.value.trim();
      if(!ticker) { status.textContent = 'Please enter a ticker'; return; }
      status.textContent = `Fetching & predicting ${ticker.toUpperCase()} â€” please wait...`;
      btn.disabled = true;
      try {
        const res = await fetch('/api/predict', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({symbol: ticker})
        });
        if(!res.ok){
          const txt = await res.text();
          status.textContent = `Error: ${res.status} â€” ${txt}`;
          output.style.display='none';
        } else {
          const data = await res.json();
          renderResult(data);
          status.textContent = `Prediction complete for ${data.symbol}`;
        }
      } catch(err){
        status.textContent = 'Network or server error: ' + err;
        output.style.display='none';
      } finally {
        btn.disabled = false;
      }
    }

    btn.addEventListener('click', runPrediction);
    tickerInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') runPrediction(); });
  </script>
</body>
</html>
