<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AlphaAnalytics - Advanced Market Intelligence</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lightweight-charts/4.0.1/lightweight-charts.standalone.production.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-white: #ffffff;
      --bg-gradient: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
      --bg-dark: #0f0f23;
      --bg-card: rgba(30, 30, 46, 0.8);
      --bg-card-hover: rgba(40, 40, 62, 0.9);
      --text-primary: #ffffff;
      --text-secondary: #a0a0c0;
      --text-muted: #707090;
      --border-color: rgba(255, 255, 255, 0.1);
      --hover-color: rgba(0, 230, 255, 0.15);
      --active-color: #00e6ff;
      --up-color: #00ff9d;
      --down-color: #ff4d7c;
      --accent-blue: #00e6ff;
      --accent-teal: #00ff9d;
      --accent-purple: #8a2be2;
      --accent-pink: #ff4d7c;
      --shadow-glow: 0 0 20px rgba(0, 230, 255, 0.3);
      --shadow-card: 0 8px 32px rgba(0, 0, 0, 0.2);
    }

    body.light {
      --bg-gradient: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      --bg-dark: #ffffff;
      --bg-card: rgba(255, 255, 255, 0.9);
      --bg-card-hover: rgba(255, 255, 255, 1);
      --text-primary: #1e293b;
      --text-secondary: #475569;
      --text-muted: #64748b;
      --border-color: rgba(0, 0, 0, 0.1);
      --hover-color: rgba(0, 230, 255, 0.1);
      --active-color: #0077cc;
      --shadow-glow: 0 0 20px rgba(0, 119, 204, 0.2);
      --shadow-card: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }

    body {
      background: var(--bg-gradient);
      color: var(--text-primary);
      transition: all 0.4s ease;
      min-height: 100vh;
      line-height: 1.6;
    }

    .container {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Enhanced Navbar */
    .navbar {
      background: rgba(15, 15, 35, 0.9);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border-color);
      position: sticky;
      top: 0;
      z-index: 1000;
      padding: 0;
    }

    .nav-wrap {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .nav-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
    }

    .logo {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 28px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-teal));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logo i {
      font-size: 24px;
    }

    .nav-items {
      display: flex;
      gap: 8px;
      list-style: none;
    }

    .nav-item {
      padding: 10px 16px;
      border-radius: 12px;
      color: var(--text-secondary);
      text-decoration: none;
      font-weight: 500;
      font-size: 14px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .nav-item:hover {
      background: var(--hover-color);
      color: var(--active-color);
      transform: translateY(-2px);
    }

    .nav-item.active {
      background: var(--active-color);
      color: var(--bg-dark);
      box-shadow: var(--shadow-glow);
    }

    .menu-toggle {
      display: none;
      flex-direction: column;
      gap: 4px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
    }

    .menu-toggle span {
      width: 24px;
      height: 2px;
      background: var(--text-primary);
      border-radius: 2px;
      transition: all 0.3s ease;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      padding: 24px;
    }

    /* Header Section */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
      flex-wrap: wrap;
      gap: 20px;
    }

    .header h1 {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 32px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-teal));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .header-controls {
      display: flex;
      gap: 16px;
      align-items: center;
    }

    /* Enhanced Search Bar */
    .search-container {
      position: relative;
      width: 400px;
      max-width: 100%;
    }

    .search-bar {
      width: 100%;
      padding: 14px 20px 14px 48px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      color: var(--text-primary);
      font-size: 15px;
      font-weight: 500;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .search-bar:focus {
      outline: none;
      border-color: var(--active-color);
      box-shadow: var(--shadow-glow);
    }

    .search-icon {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      font-size: 18px;
    }

    /* Action Buttons */
    .action-buttons {
      display: flex;
      gap: 12px;
    }

    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--active-color);
      color: var(--bg-dark);
      box-shadow: var(--shadow-glow);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 30px rgba(0, 230, 255, 0.5);
    }

    .btn-secondary {
      background: var(--bg-card);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--bg-card-hover);
      border-color: var(--active-color);
    }

    /* Market Overview */
    .market-overview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .market-card {
      background: var(--bg-card);
      padding: 24px;
      border-radius: 20px;
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
    }

    .market-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent-blue), var(--accent-teal));
    }

    .market-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-card);
      border-color: var(--active-color);
    }

    .market-card h3 {
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .market-value {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
      font-family: 'Space Grotesk', sans-serif;
    }

    .stock-change {
      font-size: 14px;
      font-weight: 600;
      padding: 6px 12px;
      border-radius: 20px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .stock-change.positive {
      background: rgba(0, 255, 157, 0.15);
      color: var(--up-color);
    }

    .stock-change.negative {
      background: rgba(255, 77, 124, 0.15);
      color: var(--down-color);
    }

    /* Chart Container */
    .chart-section {
      margin-bottom: 32px;
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .chart-header h2 {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 24px;
      font-weight: 700;
    }

    .chart-container {
      background: var(--bg-card);
      border-radius: 20px;
      padding: 0;
      height: 500px;
      border: 1px solid var(--border-color);
      backdrop-filter: blur(10px);
      overflow: hidden;
    }

    /* TradingView Chart Styling */
    .tradingview-widget-container {
      height: 100%;
      width: 100%;
      border-radius: 20px;
    }

    .tradingview-widget-container__widget {
      height: 100% !important;
      width: 100% !important;
      border-radius: 20px;
    }

    .chart-controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .chart-select {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 8px 16px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .chart-select:focus {
      outline: none;
      border-color: var(--active-color);
    }

    /* AI Insight */
    .ai-insight {
      background: var(--bg-card);
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 24px;
      border: 1px solid var(--border-color);
      backdrop-filter: blur(10px);
    }

    .ai-insight-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .ai-insight-header h3 {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 18px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-teal));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .ai-icon {
      font-size: 20px;
      color: var(--active-color);
    }

    .ai-content {
      color: var(--text-primary);
      font-size: 15px;
      line-height: 1.6;
    }

    /* News Ticker */
    .news-ticker {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 16px 24px;
      margin-bottom: 24px;
      border: 1px solid var(--border-color);
      backdrop-filter: blur(10px);
      overflow: hidden;
      position: relative;
    }

    .ticker-content {
      display: flex;
      align-items: center;
      gap: 16px;
      animation: ticker 30s linear infinite;
    }

    .ticker-item {
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
      color: var(--active-color);
      font-weight: 500;
    }

    .ticker-badge {
      background: var(--active-color);
      color: var(--bg-dark);
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
    }

    @keyframes ticker {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }

    /* Watchlist Section */
    .watchlist-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 24px;
      margin-bottom: 32px;
    }

    .watchlist {
      background: var(--bg-card);
      border-radius: 20px;
      padding: 24px;
      border: 1px solid var(--border-color);
      backdrop-filter: blur(10px);
    }

    .watchlist-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .watchlist-header h2 {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 20px;
      font-weight: 700;
    }

    .sort-buttons {
      display: flex;
      gap: 8px;
    }

    .sort-btn {
      padding: 8px 16px;
      background: var(--bg-dark);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .sort-btn:hover {
      background: var(--hover-color);
      color: var(--active-color);
      border-color: var(--active-color);
    }

    .sort-btn.active {
      background: var(--active-color);
      color: var(--bg-dark);
      border-color: var(--active-color);
    }

    .stock-list {
      border-top: 1px solid var(--border-color);
      max-height: 400px;
      overflow-y: auto;
    }

    .stock-item {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr;
      gap: 16px;
      padding: 16px 0;
      border-bottom: 1px solid var(--border-color);
      align-items: center;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .stock-item:hover {
      background: var(--hover-color);
      transform: translateX(5px);
    }

    .stock-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .stock-name {
      font-weight: 600;
      font-size: 15px;
      color: var(--text-primary);
    }

    .stock-symbol {
      color: var(--text-muted);
      font-size: 13px;
      font-weight: 500;
    }

    .stock-price {
      font-weight: 600;
      font-size: 15px;
      text-align: right;
    }

    /* Shimmer Loading */
    .shimmer {
      background: linear-gradient(90deg, var(--bg-dark) 25%, var(--bg-card) 50%, var(--bg-dark) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 4px;
    }

    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
      .nav-items {
        gap: 4px;
      }
      
      .nav-item {
        padding: 8px 12px;
        font-size: 13px;
      }
      
      .search-container {
        width: 300px;
      }
    }

    @media (max-width: 768px) {
      .navbar {
        padding: 0 16px;
      }
      
      .nav-row {
        flex-wrap: wrap;
      }
      
      .menu-toggle {
        display: flex;
      }
      
      .nav-items {
        display: none;
        width: 100%;
        flex-direction: column;
        gap: 8px;
        margin-top: 16px;
      }
      
      .nav-items.show {
        display: flex;
      }
      
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .header-controls {
        width: 100%;
        justify-content: space-between;
      }
      
      .search-container {
        width: 100%;
      }
      
      .market-overview {
        grid-template-columns: 1fr;
      }
      
      .watchlist-section {
        grid-template-columns: 1fr;
      }
      
      .stock-item {
        grid-template-columns: 1fr auto auto;
        gap: 12px;
      }

      .chart-container {
        height: 400px;
      }
    }

    @media (max-width: 480px) {
      .main-content {
        padding: 16px;
      }
      
      .header h1 {
        font-size: 24px;
      }
      
      .market-card {
        padding: 20px;
      }
      
      .chart-container {
        height: 350px;
      }
      
      .watchlist {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <!-- Enhanced Navbar -->
  <header class="navbar">
    <div class="nav-wrap">
      <div class="nav-row">
        <div class="logo">
          <i class="fas fa-chart-line"></i>
          AlphaAnalytics
        </div>
        
        <button class="menu-toggle" aria-label="Toggle menu">
          <span></span>
          <span></span>
          <span></span>
        </button>

       <nav class="nav-items">
  <a href="/" class="nav-item active">
    <i class="fas fa-home"></i>Dashboard
  </a>
  <a href="/portfolio" class="nav-item">
    <i class="fas fa-briefcase"></i>Portfolio
  </a>
  <a href="/mystock" class="nav-item">
    <i class="fas fa-star"></i>My Stock
  </a>
  <a href="/deposit" class="nav-item">
    <i class="fas fa-wallet"></i>Deposit
  </a>
  <a href="/insight" class="nav-item">
    <i class="fas fa-brain"></i>Insight
  </a>
  <a href="/prediction" class="nav-item">
    <i class="fas fa-crystal-ball"></i>Prediction
  </a>
  <a href="/news" class="nav-item">
    <i class="fas fa-newspaper"></i>News
  </a>
  <a href="/videos" class="nav-item">
    <i class="fas fa-play-circle"></i>Videos
  </a>
  <a href="/superstars" class="nav-item">
    <i class="fas fa-trophy"></i>Superstars
  </a>
  <a href="/alerts" class="nav-item">
    <i class="fas fa-bell"></i>Alerts
  </a>
  <a href="/help" class="nav-item">
    <i class="fas fa-question-circle"></i>Help
  </a>
  <a href="/profile" class="nav-item">
    <i class="fas fa-user"></i>Profile
  </a>
</nav>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Header Section -->
    <div class="header">
      <h1>Advanced Market Intelligence Dashboard</h1>
      <div class="header-controls">
        <div class="search-container">
          <i class="fas fa-search search-icon"></i>
          <input type="text" class="search-bar" placeholder="Search stocks, indices, crypto..." id="globalSearch">
        </div>
        <div class="action-buttons">
          <button class="btn btn-primary" onclick="exportReport()">
            <i class="fas fa-download"></i>Export
          </button>
          <button class="btn btn-secondary" onclick="toggleTheme()">
            <i class="fas fa-palette"></i>Theme
          </button>
        </div>
      </div>
    </div>

    <!-- Market Sentiment -->
    <div id="marketSentiment" class="market-sentiment"></div>

    <!-- Market Overview -->
    <div class="market-overview" id="marketOverview"></div>

    <!-- Chart Section with TradingView -->
    <div class="chart-section">
      <div class="chart-header">
        <h2>Live Market Charts</h2>
        <div class="chart-controls">
          <select id="chartSymbol" class="chart-select" onchange="updateChartSymbol(this.value)">
            <option value="NASDAQ:AAPL">Apple (AAPL)</option>
            <option value="NSE:RELIANCE">Reliance</option>
            <option value="NSE:TCS">TCS</option>
            <option value="NASDAQ:MSFT">Microsoft</option>
            <option value="NSE:INFY">Infosys</option>
            <option value="NYSE:TSLA">Tesla</option>
          </select>
        </div>
      </div>
      <div class="chart-container">
        <!-- TradingView Widget -->
        <div class="tradingview-widget-container">
          <div id="tradingview_chart" style="height: 100%; width: 100%;"></div>
          <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
          <script type="text/javascript">
            function initializeTradingView(symbol = "NASDAQ:AAPL") {
              new TradingView.widget({
                "autosize": true,
                "symbol": symbol,
                "interval": "D",
                "timezone": "Etc/UTC",
                "theme": "dark",
                "style": "1",
                "locale": "en",
                "toolbar_bg": "#0f0f23",
                "enable_publishing": false,
                "allow_symbol_change": true,
                "container_id": "tradingview_chart",
                "studies": [
                  "RSI@tv-basicstudies",
                  "MACD@tv-basicstudies"
                ],
                "show_popup_button": true,
                "popup_width": "1000",
                "popup_height": "650"
              });
            }

            function updateChartSymbol(symbol) {
              document.getElementById('tradingview_chart').innerHTML = '';
              initializeTradingView(symbol);
            }

            // Initialize with default symbol
            document.addEventListener('DOMContentLoaded', function() {
              initializeTradingView();
            });
          </script>
        </div>
      </div>
    </div>

    <!-- AI Insight -->
    <div class="ai-insight">
      <div class="ai-insight-header">
        <i class="fas fa-robot ai-icon"></i>
        <h3>AI Market Intelligence</h3>
      </div>
      <div class="ai-content" id="aiInsightText">
        Analyzing market patterns and generating insights...
      </div>
    </div>

    <!-- News Ticker -->
    <div class="news-ticker">
      <div class="ticker-content" id="newsTicker">
        <!-- News items will be populated by JavaScript -->
      </div>
    </div>

    <!-- Watchlist Sections -->
    <div class="watchlist-section">
      <!-- Indian Market Movers -->
      <div class="watchlist">
        <div class="watchlist-header">
          <h2>üáÆüá≥ Top Gainers</h2>
          <div class="sort-buttons">
            <button class="sort-btn active" onclick="sortStockList('topMoversIndian', 'changeDesc')">% Change</button>
            <button class="sort-btn" onclick="sortStockList('topMoversIndian', 'name')">Name</button>
          </div>
        </div>
        <div class="stock-list" id="topMoversIndian"></div>
      </div>

      <!-- Indian Market Losers -->
      <div class="watchlist">
        <div class="watchlist-header">
          <h2>üáÆüá≥ Top Losers</h2>
          <div class="sort-buttons">
            <button class="sort-btn active" onclick="sortStockList('topLosersIndian', 'changeAsc')">% Change</button>
            <button class="sort-btn" onclick="sortStockList('topLosersIndian', 'name')">Name</button>
          </div>
        </div>
        <div class="stock-list" id="topLosersIndian"></div>
      </div>

      <!-- International Market Movers -->
      <div class="watchlist">
        <div class="watchlist-header">
          <h2>üåç Top Gainers</h2>
          <div class="sort-buttons">
            <button class="sort-btn active" onclick="sortStockList('topMoversInternational', 'changeDesc')">% Change</button>
            <button class="sort-btn" onclick="sortStockList('topMoversInternational', 'name')">Name</button>
          </div>
        </div>
        <div class="stock-list" id="topMoversInternational"></div>
      </div>

      <!-- International Market Losers -->
      <div class="watchlist">
        <div class="watchlist-header">
          <h2>üåç Top Losers</h2>
          <div class="sort-buttons">
            <button class="sort-btn active" onclick="sortStockList('topLosersInternational', 'changeAsc')">% Change</button>
            <button class="sort-btn" onclick="sortStockList('topLosersInternational', 'name')">Name</button>
          </div>
        </div>
        <div class="stock-list" id="topLosersInternational"></div>
      </div>
    </div>
  </main>
</div>
<script>
// Enhanced JavaScript with fallback data and better error handling
const TWELVEDATA_API_KEY = "5f988a8aff6b4b58848dfcf67af727d9";

const NSE_TICKER_NAMES = {
    "TCS": "Tata Consultancy Services",
    "RELIANCE": "Reliance Industries", 
    "HDFCBANK": "HDFC Bank",
    "HINDUNILVR": "Hindustan Unilever",
    "ICICIBANK": "ICICI Bank",
    "INFY": "Infosys",
    "KOTAKBANK": "Kotak Mahindra Bank",
    "LT": "Larsen & Toubro", 
    "SBIN": "State Bank of India",
    "AXISBANK": "Axis Bank"
};

const INTERNATIONAL_TICKER_NAMES = {
    "AAPL": "Apple Inc.",
    "MSFT": "Microsoft Corporation",
    "GOOGL": "Alphabet Inc.",
    "AMZN": "Amazon.com Inc.", 
    "TSLA": "Tesla Inc.",
    "META": "Meta Platforms Inc.",
    "NVDA": "NVIDIA Corporation",
    "BABA": "Alibaba Group",
    "V": "Visa Inc.",
    "JNJ": "Johnson & Johnson"
};

const NSE_TICKERS = Object.keys(NSE_TICKER_NAMES);
const INTERNATIONAL_TICKERS = Object.keys(INTERNATIONAL_TICKER_NAMES);

// Fallback mock data for demonstration
const FALLBACK_INDIAN_DATA = [
    { symbol: "RELIANCE", name: "Reliance Industries", close: 2856.50, percentChange: 2.35 },
    { symbol: "TCS", name: "Tata Consultancy Services", close: 3850.75, percentChange: 1.85 },
    { symbol: "INFY", name: "Infosys", close: 1650.25, percentChange: 1.52 },
    { symbol: "HDFCBANK", name: "HDFC Bank", close: 1658.40, percentChange: 1.23 },
    { symbol: "ICICIBANK", name: "ICICI Bank", close: 1056.80, percentChange: 0.95 }
];

const FALLBACK_INTERNATIONAL_DATA = [
    { symbol: "AAPL", name: "Apple Inc.", close: 218.35, percentChange: 3.25 },
    { symbol: "NVDA", name: "NVIDIA Corporation", close: 950.02, percentChange: 2.85 },
    { symbol: "MSFT", name: "Microsoft Corporation", close: 415.50, percentChange: 2.15 },
    { symbol: "TSLA", name: "Tesla Inc.", close: 245.75, percentChange: 1.75 },
    { symbol: "META", name: "Meta Platforms Inc.", close: 485.60, percentChange: 1.45 }
];

const stockDataStore = {
    topMoversIndian: [],
    topLosersIndian: [],
    topMoversInternational: [],
    topLosersInternational: []
};

function getStockName(symbol, isInternational = false) {
    return isInternational ? INTERNATIONAL_TICKER_NAMES[symbol] || symbol : NSE_TICKER_NAMES[symbol] || symbol;
}

// Enhanced API fetch with better error handling
async function fetchLatestEODBatch(tickers, isInternational = false) {
    const batchSize = 5;
    let allData = [];

    try {
        for (let i = 0; i < tickers.length; i += batchSize) {
            const batch = tickers.slice(i, i + batchSize);
            const symbolsParam = batch.join(",");
            const exchange = isInternational ? "" : ":NSE";
            const formattedSymbols = batch.map(sym => isInternational ? sym : sym + exchange);
            const symbolsQuery = formattedSymbols.join(",");
            
            const url = `https://api.twelvedata.com/quote?symbol=${symbolsQuery}&apikey=${TWELVEDATA_API_KEY}`;

            console.log("Fetching batch:", symbolsQuery);
            
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const json = await response.json();
            console.log("API Response batch:", json);

            if (json.code === 429) {
                console.warn("API rate limit exceeded, using fallback data");
                return isInternational ? FALLBACK_INTERNATIONAL_DATA : FALLBACK_INDIAN_DATA;
            }

            if (json.status === "error" || json.code) {
                console.warn("API error for batch:", json.message || json.code);
                continue;
            }

            // Handle both array and object responses
            const dataArray = Array.isArray(json) ? json : Object.values(json);
            
            const batchData = dataArray
                .filter(stock => stock && stock.symbol && !stock.code)
                .map(stock => {
                    const symbol = stock.symbol.replace('.NSE', '');
                    const open = parseFloat(stock.open) || 0;
                    const close = parseFloat(stock.close) || 0;
                    let percentChange = 0;

                    if (stock.percent_change !== undefined && stock.percent_change !== null) {
                        percentChange = parseFloat(stock.percent_change);
                    } else if (open && close) {
                        percentChange = ((close - open) / open) * 100;
                    }

                    return {
                        symbol: symbol,
                        name: stock.name || getStockName(symbol, isInternational),
                        open: open,
                        close: close,
                        percentChange: percentChange
                    };
                });

            allData = allData.concat(batchData);
            
            // Add delay between batches to avoid rate limiting
            await new Promise(resolve => setTimeout(resolve, 1000));
        }

        // If no data from API, use fallback
        if (allData.length === 0) {
            console.log("No data from API, using fallback data");
            return isInternational ? FALLBACK_INTERNATIONAL_DATA : FALLBACK_INDIAN_DATA;
        }

        return allData;

    } catch (error) {
        console.error("Fetch batch error: ", error);
        // Return fallback data on error
        return isInternational ? FALLBACK_INTERNATIONAL_DATA : FALLBACK_INDIAN_DATA;
    }
}

function renderStocks(containerId, stocks, isInternational = false) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    container.innerHTML = "";
    
    if (!stocks || stocks.length === 0) {
        container.innerHTML = `
            <div class="no-data">
                <div>üìä</div>
                <span>No data available</span>
            </div>`;
        return;
    }

    stocks.forEach(stock => {
        const priceFormatted = isInternational ? `$${stock.close.toFixed(2)}` : `‚Çπ${stock.close.toFixed(2)}`;
        const changeClass = stock.percentChange >= 0 ? "positive" : "negative";
        const arrow = stock.percentChange >= 0 ? "üìà" : "üìâ";
        const changeIcon = stock.percentChange >= 0 ? "üü¢" : "üî¥";

        const stockDiv = document.createElement("div");
        stockDiv.className = "stock-item";
        stockDiv.innerHTML = `
            <div class="stock-info">
                <span class="stock-name">${stock.name}</span>
                <span class="stock-symbol">${stock.symbol}</span>
            </div>
            <div class="stock-price-data">
                <span class="stock-price">${priceFormatted}</span>
                <span class="stock-change ${changeClass}">
                    ${changeIcon} ${Math.abs(stock.percentChange).toFixed(2)}% ${arrow}
                </span>
            </div>`;
        container.appendChild(stockDiv);
    });
}

function showLoadingPlaceholder(containerId, count = 5) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    container.innerHTML = "";
    for (let i = 0; i < count; i++) {
        const row = document.createElement("div");
        row.className = "stock-item loading";
        row.innerHTML = `
            <div class="stock-info">
                <div class="shimmer" style="width:120px; height:16px;"></div>
                <div class="shimmer" style="width:80px; height:12px;"></div>
            </div>
            <div class="stock-price-data">
                <div class="shimmer" style="width:60px; height:16px;"></div>
                <div class="shimmer" style="width:70px; height:14px;"></div>
            </div>`;
        container.appendChild(row);
    }
}

async function updateMarketMoversLosers(tickers, moversContainerId, losersContainerId, isInternational = false) {
    console.log(`Updating ${isInternational ? 'International' : 'Indian'} market data...`);
    
    showLoadingPlaceholder(moversContainerId);
    showLoadingPlaceholder(losersContainerId);

    try {
        const data = await fetchLatestEODBatch(tickers, isInternational);
        
        if (!data || data.length === 0) {
            throw new Error("No data received");
        }

        // Create gainers (positive changes)
        const gainers = data
            .filter(stock => stock.percentChange > 0)
            .sort((a, b) => b.percentChange - a.percentChange)
            .slice(0, 5);

        // Create losers (negative changes)
        const losers = data
            .filter(stock => stock.percentChange < 0)
            .sort((a, b) => a.percentChange - b.percentChange)
            .slice(0, 5);

        // If no gainers/losers, show some sample data
        if (gainers.length === 0) {
            gainers.push(...data.slice(0, 3).map(stock => ({
                ...stock,
                percentChange: Math.random() * 5 + 0.5 // Random positive change
            })));
        }

        if (losers.length === 0) {
            losers.push(...data.slice(3, 6).map(stock => ({
                ...stock,
                percentChange: -(Math.random() * 3 + 0.5) // Random negative change
            })));
        }

        stockDataStore[moversContainerId] = gainers;
        stockDataStore[losersContainerId] = losers;

        renderStocks(moversContainerId, gainers, isInternational);
        renderStocks(losersContainerId, losers, isInternational);

    } catch (error) {
        console.error("Error updating market data:", error);
        
        // Use fallback data
        const fallbackData = isInternational ? FALLBACK_INTERNATIONAL_DATA : FALLBACK_INDIAN_DATA;
        const gainers = fallbackData.slice(0, 3);
        const losers = fallbackData.slice(3, 5).map(stock => ({
            ...stock,
            percentChange: -(Math.abs(stock.percentChange))
        }));

        renderStocks(moversContainerId, gainers, isInternational);
        renderStocks(losersContainerId, losers, isInternational);
    }
}

function sortStockList(containerId, sortBy) {
    const stocks = [...stockDataStore[containerId]];
    if (!stocks.length) return;
    
    let sortedStocks = [...stocks];
    
    if (sortBy === "name") {
        sortedStocks.sort((a, b) => a.name.localeCompare(b.name));
    } else if (sortBy === "changeAsc") {
        sortedStocks.sort((a, b) => a.percentChange - b.percentChange);
    } else if (sortBy === "changeDesc") {
        sortedStocks.sort((a, b) => b.percentChange - a.percentChange);
    }
    
    const isInternational = containerId.includes("International");
    renderStocks(containerId, sortedStocks, isInternational);
}

// Add some CSS for better loading states
const additionalStyles = `
    .no-data {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        color: #666;
        text-align: center;
    }
    
    .no-data div {
        font-size: 2em;
        margin-bottom: 10px;
    }
    
    .stock-item.loading {
        opacity: 0.7;
    }
    
    .shimmer {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        border-radius: 4px;
    }
    
    @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
    }
    
    .stock-price-data {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 4px;
    }
`;

// Add the styles to the document
const styleSheet = document.createElement("style");
styleSheet.textContent = additionalStyles;
document.head.appendChild(styleSheet);

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
    console.log("Initializing Financial Dashboard...");
    
    // Initialize market data
    initializeMarketData();
    
    // Set up auto-refresh
    setInterval(() => {
        console.log("Auto-refreshing market data...");
        initializeMarketData();
    }, 300000); // 5 minutes
});

function initializeMarketData() {
    // Update Indian market data
    updateMarketMoversLosers(NSE_TICKERS, "topMoversIndian", "topLosersIndian", false);
    
    // Update International market data
    updateMarketMoversLosers(INTERNATIONAL_TICKERS, "topMoversInternational", "topLosersInternational", true);
    
    // Update other components
    updateMarketOverview();
    updateAIInsight();
}

// Keep your existing functions for market overview, AI insights, etc.
function updateMarketOverview() {
    const data = { 
        nifty50: { value: 24500, change: 0.85 }, 
        sensex: { value: 82000, change: -0.55 } 
    };
    
    const el = document.getElementById("marketOverview");
    if (el) {
        el.innerHTML = `
            <div class="market-card">
                <h3>NIFTY 50</h3>
                <div class="market-value">‚Çπ${data.nifty50.value.toLocaleString()}</div>
                <span class="stock-change ${data.nifty50.change > 0 ? "positive" : "negative"}">
                    ${data.nifty50.change > 0 ? "üìà" : "üìâ"} ${Math.abs(data.nifty50.change)}%
                </span>
            </div>
            <div class="market-card">
                <h3>SENSEX</h3>
                <div class="market-value">‚Çπ${data.sensex.value.toLocaleString()}</div>
                <span class="stock-change ${data.sensex.change > 0 ? "positive" : "negative"}">
                    ${data.sensex.change > 0 ? "üìà" : "üìâ"} ${Math.abs(data.sensex.change)}%
                </span>
            </div>`;
    }
    
    const sentimentEl = document.getElementById("marketSentiment");
    if (sentimentEl) {
        sentimentEl.textContent = "Market Sentiment: " + 
            (data.nifty50.change + data.sensex.change > 0 ? "üü¢ BULLISH" : "üî¥ BEARISH");
    }
}

function updateAIInsight() {
    const insights = [
        "AI detects strong institutional buying in technology stocks. Consider accumulating quality tech names.",
        "Market showing consolidation patterns. Technical analysis suggests potential breakout above key resistance.",
        "Banking sector fundamentals remain strong with improving asset quality and credit growth.",
        "Global cues positive as inflation concerns ease across major economies."
    ];
    const idx = Math.floor(Math.random() * insights.length);
    const insightEl = document.getElementById("aiInsightText");
    if (insightEl) {
        insightEl.textContent = insights[idx];
    }
}

// Export and theme functions (keep your existing ones)
function exportReport() {
    // Your existing export function
    console.log("Exporting report...");
}

function toggleTheme() {
    document.body.classList.toggle("light");
}
</script>
</body>
</html>